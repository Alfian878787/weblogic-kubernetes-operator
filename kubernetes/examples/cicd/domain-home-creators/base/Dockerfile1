# Copyright 2019, Oracle Corporation and/or its affiliates.  All rights reserved.
# Licensed under the Universal Permissive License v 1.0 as shown at http://oss.oracle.com/licenses/upl.

FROM store/oracle/weblogic:12.2.1.3

ENV DOMAIN_NAME="domain1" \
    BUILD_TMP="${ORACLE_HOME}/docker-build-tmp" \
    WLS_CREDENTIALS="/weblogic-credentials"

ENV DOMAIN_HOME="${ORACLE_HOME}/user_projects/domains/${DOMAIN_NAME}"

ARG ENCODED_ADMIN_USERNAME
ARG ENCODED_ADMIN_PASSWORD

USER root

RUN mkdir -p ${DOMAIN_HOME} && \
    mkdir -p ${BUILD_TMP} && \
    mkdir -p ${WLS_CREDENTIALS} && \
    echo ${ENCODED_ADMIN_USERNAME} | base64 --decode > ${WLS_CREDENTIALS}/username && \
    echo ${ENCODED_ADMIN_PASSWORD} | base64 --decode > ${WLS_CREDENTIALS}/password

COPY model/model.yaml ${BUILD_TMP}
COPY weblogic-deploy.zip ${BUILD_TMP}

RUN cd ${BUILD_TMP} && \
    ${JAVA_HOME}/bin/jar xf weblogic-deploy.zip && \
    chmod +x weblogic-deploy/bin/*.sh && \
    ${BUILD_TMP}/weblogic-deploy/bin/createDomain.sh \
      -oracle_home ${ORACLE_HOME} \
      -java_home ${JAVA_HOME} \
      -domain_home ${DOMAIN_HOME} \
      -domain_type WLS \
      -model_file ${BUILD_TMP}/model.yaml && \
    cd ${DOMAIN_HOME} && \
    chown -R oracle:oracle ${DOMAIN_HOME} && \
    chmod -R a+xwr ${DOMAIN_HOME} && \
    cat ${DOMAIN_HOME}/config/config.xml && \
    rm -rf ${BUILD_TMP} && \
    rm -rf ${WLS_CREDENTIALS} && \
    ${JAVA_HOME}/bin/jar cf /u01/${DOMAIN_NAME}.zip . && \
    echo "#/bin/bash" > /u01/wait.sh && \
    echo "while true ; do sleep 60; done" >> /u01/wait.sh && \
    chmod a+x /u01/wait.sh

CMD /u01/wait.sh
